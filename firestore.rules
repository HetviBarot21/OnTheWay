rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is in a circle
    function isCircleMember(circleId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/circles/$(circleId)) &&
             request.auth.uid in get(/databases/$(database)/documents/circles/$(circleId)).data.members;
    }
    
    // Users collection - stores user profile data
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for circle members)
      allow read: if isAuthenticated();
      // Only the user can create/update their own profile
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
      
      // User invites subcollection
      match /invites/{inviteId} {
        allow read, write: if isOwner(userId);
      }
      
      // User online status subcollection
      match /status/{statusDoc} {
        // Anyone authenticated can read status (for circle members)
        allow read: if isAuthenticated();
        // Only the user can write their own status
        allow write: if isOwner(userId);
      }
      
      // User contacts subcollection
      match /contacts/{contactId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Circles collection - stores circle data with invite codes
    match /circles/{circleId} {
      // Allow reading circles if user is a member
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.members;
      
      // Allow listing/querying circles for anyone authenticated (needed for invite code search)
      allow list: if isAuthenticated();
      
      // Any authenticated user can create a circle
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.members;
      
      // Allow update if user is adding themselves to members (joining) or already a member
      allow update: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.members;
      
      // Only creator can delete
      allow delete: if isAuthenticated() && 
                       request.auth.uid == resource.data.createdBy;
    }
    
    // Circle members collection - tracks membership
    match /circle_members/{memberDoc} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Locations collection - stores real-time location data
    match /locations/{userId} {
      // Any authenticated user can read locations (for circle members)
      allow read: if isAuthenticated();
      // Only the user can write their own location
      allow write: if isOwner(userId);
      
      // Location updates subcollection - per-circle location updates
      match /updates/{updateId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }
    }
    
    // Pending invites collection - for users not yet registered
    match /pending_invites/{phoneHash} {
      allow read, write: if isAuthenticated();
      
      match /invites/{inviteId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Trips collection - active trip tracking
    match /trips/{tripId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAuthenticated() && 
                               request.auth.uid == resource.data.userId;
    }
    
    // Geofences collection - location-based notifications
    match /geofences/{geofenceId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAuthenticated() && 
                               request.auth.uid == resource.data.userId;
    }
    
    // SOS events collection
    match /sos_events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }
  }
}
